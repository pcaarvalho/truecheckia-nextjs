<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueCheckIA Browser Tests</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #cce7ff; border-color: #b6d4fe; }
        button {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .response { 
            margin: 10px 0; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            font-family: monospace; 
            white-space: pre-wrap;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        textarea { height: 100px; resize: vertical; }
    </style>
</head>
<body>
    <h1>ğŸ§ª TrueCheckIA End-to-End Browser Tests</h1>
    
    <div class="test-section info">
        <h2>ğŸ“ Test Configuration</h2>
        <p><strong>Server:</strong> http://localhost:3001</p>
        <p><strong>Test User:</strong> test@truecheckia.com</p>
        <p><strong>Password:</strong> Test123456!</p>
    </div>

    <div class="test-section" id="auth-section">
        <h2>ğŸ” 1. Authentication Tests</h2>
        <div>
            <button onclick="testLogin()">Test Login</button>
            <button onclick="testRefresh()">Test Token Refresh</button>
            <button onclick="testLogout()">Test Logout</button>
            <button onclick="clearStorage()">Clear Local Storage</button>
        </div>
        <div id="auth-response" class="response"></div>
        <div>
            <strong>Current Auth State:</strong>
            <div id="auth-state" style="font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <div class="test-section" id="analysis-section">
        <h2>ğŸ” 2. Analysis Tests</h2>
        <div>
            <textarea id="analysis-text" placeholder="Enter text to analyze (minimum 50 characters)">This is a comprehensive test text that we are using to analyze and detect whether the content was generated by artificial intelligence systems or written by human authors. This text should be long enough to pass the minimum character requirement for the analysis system to properly function and provide meaningful results.</textarea>
            <button onclick="testAnalysis()">Run Analysis</button>
            <button onclick="testAnalysisHistory()">Get Analysis History</button>
        </div>
        <div id="analysis-response" class="response"></div>
    </div>

    <div class="test-section" id="navigation-section">
        <h2>ğŸ§­ 3. Navigation Tests</h2>
        <div>
            <button onclick="testPageAccess('/dashboard')">Access Dashboard</button>
            <button onclick="testPageAccess('/analysis')">Access Analysis Page</button>
            <button onclick="testPageAccess('/history')">Access History</button>
            <button onclick="testPageAccess('/profile')">Access Profile</button>
            <button onclick="testPageAccess('/settings')">Access Settings</button>
        </div>
        <div id="navigation-response" class="response"></div>
    </div>

    <div class="test-section" id="system-section">
        <h2>âš™ï¸ 4. System Health Tests</h2>
        <div>
            <button onclick="testHealth()">Test Health Endpoint</button>
            <button onclick="testUserCredits()">Check User Credits</button>
        </div>
        <div id="system-response" class="response"></div>
    </div>

    <div class="test-section" id="results-section">
        <h2>ğŸ“Š 5. Test Results Summary</h2>
        <div id="test-summary">
            <p>Tests completed: <span id="completed-tests">0</span></p>
            <p>Tests passed: <span id="passed-tests">0</span></p>
            <p>Tests failed: <span id="failed-tests">0</span></p>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3001';
        let testResults = { completed: 0, passed: 0, failed: 0 };
        let currentTokens = {};

        // Update auth state display
        function updateAuthState() {
            const authState = document.getElementById('auth-state');
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken');
            const user = localStorage.getItem('user');
            
            authState.innerHTML = `
Access Token: ${accessToken ? accessToken.substring(0, 50) + '...' : 'None'}
Refresh Token: ${refreshToken ? refreshToken.substring(0, 50) + '...' : 'None'}
User: ${user || 'None'}
            `.trim();
        }

        // Log test result
        function logTestResult(testName, success, response, error = null) {
            testResults.completed++;
            if (success) {
                testResults.passed++;
                console.log(`âœ… ${testName}:`, response);
            } else {
                testResults.failed++;
                console.error(`âŒ ${testName}:`, error || response);
            }
            
            document.getElementById('completed-tests').textContent = testResults.completed;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
        }

        // Display response
        function displayResponse(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
            element.style.background = isError ? '#ffebee' : '#f8f9fa';
        }

        // Test login
        async function testLogin() {
            try {
                const response = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@truecheckia.com',
                        password: 'Test123456!'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data.accessToken) {
                    localStorage.setItem('accessToken', data.data.accessToken);
                    localStorage.setItem('refreshToken', data.data.refreshToken);
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                    
                    currentTokens = {
                        accessToken: data.data.accessToken,
                        refreshToken: data.data.refreshToken
                    };
                    
                    displayResponse('auth-response', data);
                    logTestResult('Login', true, data);
                    updateAuthState();
                } else {
                    throw new Error(data.error?.message || 'Login failed');
                }
            } catch (error) {
                displayResponse('auth-response', error.message, true);
                logTestResult('Login', false, null, error.message);
            }
        }

        // Test token refresh
        async function testRefresh() {
            const refreshToken = localStorage.getItem('refreshToken');
            
            if (!refreshToken) {
                displayResponse('auth-response', 'No refresh token available', true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('accessToken', data.data.accessToken);
                    localStorage.setItem('refreshToken', data.data.refreshToken);
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                    
                    currentTokens = {
                        accessToken: data.data.accessToken,
                        refreshToken: data.data.refreshToken
                    };
                    
                    displayResponse('auth-response', data);
                    logTestResult('Token Refresh', true, data);
                    updateAuthState();
                } else {
                    throw new Error(data.error?.message || 'Token refresh failed');
                }
            } catch (error) {
                displayResponse('auth-response', error.message, true);
                logTestResult('Token Refresh', false, null, error.message);
            }
        }

        // Test logout
        async function testLogout() {
            try {
                const response = await fetch(`${BASE_URL}/api/auth/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                
                if (data.success) {
                    localStorage.clear();
                    currentTokens = {};
                    displayResponse('auth-response', data);
                    logTestResult('Logout', true, data);
                    updateAuthState();
                } else {
                    throw new Error(data.error?.message || 'Logout failed');
                }
            } catch (error) {
                displayResponse('auth-response', error.message, true);
                logTestResult('Logout', false, null, error.message);
            }
        }

        // Clear local storage
        function clearStorage() {
            localStorage.clear();
            currentTokens = {};
            updateAuthState();
            displayResponse('auth-response', 'Local storage cleared');
        }

        // Test analysis
        async function testAnalysis() {
            const text = document.getElementById('analysis-text').value;
            const accessToken = localStorage.getItem('accessToken');
            
            if (!accessToken) {
                displayResponse('analysis-response', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ text })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayResponse('analysis-response', data);
                    logTestResult('Analysis', true, data);
                } else {
                    throw new Error(data.error?.message || 'Analysis failed');
                }
            } catch (error) {
                displayResponse('analysis-response', error.message, true);
                logTestResult('Analysis', false, null, error.message);
            }
        }

        // Test analysis history
        async function testAnalysisHistory() {
            const accessToken = localStorage.getItem('accessToken');
            
            if (!accessToken) {
                displayResponse('analysis-response', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                displayResponse('analysis-response', data);
                logTestResult('Analysis History', response.ok, data);
            } catch (error) {
                displayResponse('analysis-response', error.message, true);
                logTestResult('Analysis History', false, null, error.message);
            }
        }

        // Test page access
        async function testPageAccess(path) {
            try {
                // First test: without auth (should redirect to login)
                let response = await fetch(`${BASE_URL}${path}`, {
                    redirect: 'manual'
                });
                
                let unauthResult = `Without auth: ${response.status} ${response.statusText}`;
                
                // Second test: with auth token
                const accessToken = localStorage.getItem('accessToken');
                if (accessToken) {
                    response = await fetch(`${BASE_URL}${path}`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        redirect: 'manual'
                    });
                    unauthResult += `\nWith auth: ${response.status} ${response.statusText}`;
                }
                
                displayResponse('navigation-response', unauthResult);
                logTestResult(`Page Access ${path}`, true, { status: response.status });
            } catch (error) {
                displayResponse('navigation-response', error.message, true);
                logTestResult(`Page Access ${path}`, false, null, error.message);
            }
        }

        // Test health endpoint
        async function testHealth() {
            try {
                const response = await fetch(`${BASE_URL}/api/health`);
                const data = await response.json();
                
                displayResponse('system-response', data);
                logTestResult('Health Check', data.success, data);
            } catch (error) {
                displayResponse('system-response', error.message, true);
                logTestResult('Health Check', false, null, error.message);
            }
        }

        // Test user credits
        async function testUserCredits() {
            const accessToken = localStorage.getItem('accessToken');
            
            if (!accessToken) {
                displayResponse('system-response', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/dashboard/credits`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                displayResponse('system-response', data);
                logTestResult('User Credits', response.ok, data);
            } catch (error) {
                displayResponse('system-response', error.message, true);
                logTestResult('User Credits', false, null, error.message);
            }
        }

        // Initialize
        updateAuthState();
        
        // Auto-run basic tests
        window.addEventListener('load', () => {
            console.log('ğŸš€ TrueCheckIA Browser Tests Initialized');
            console.log('ğŸ’¡ Click the buttons above to run individual tests');
            console.log('ğŸ”‘ Recommended order: Login â†’ Analysis â†’ Navigation â†’ System');
        });
    </script>
</body>
</html>